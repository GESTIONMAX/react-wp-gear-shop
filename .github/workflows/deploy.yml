---
name: ðŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'

jobs:
  security-check:
    name: ðŸ”’ Pre-deployment Security Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --fund false

      - name: ðŸ” Critical security audit
        run: |
          # VÃ©rification critique avant dÃ©ploiement
          if npm audit --audit-level=critical; then
            echo "âœ… No critical vulnerabilities"
          else
            echo "âŒ Critical vulnerabilities found - deployment blocked"
            exit 1
          fi

      - name: ðŸ” Environment variables check
        run: |
          # VÃ©rifier que les variables d'environnement sont dÃ©finies
          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ]; then
            echo "âŒ VITE_SUPABASE_URL not configured"
            exit 1
          fi

          if [ -z "${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" ]; then
            echo "âŒ VITE_SUPABASE_PUBLISHABLE_KEY not configured"
            exit 1
          fi

          echo "âœ… Environment variables configured"

  build:
    name: ðŸ—ï¸ Build for Production
    runs-on: ubuntu-latest
    needs: security-check

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --fund false

      - name: ðŸ§ª Run tests
        run: npm run test

      - name: ðŸ—ï¸ Build for production
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: ðŸ” Post-build security check
        run: |
          # Patterns de dÃ©tection de secrets rÃ©els pour production
          SECRET_PATTERNS=(
            "sk_[a-zA-Z0-9_]{20,}"              # Stripe secret keys
            "pk_test_[a-zA-Z0-9_]{20,}"         # Stripe test keys
            "pk_live_[a-zA-Z0-9_]{20,}"         # Stripe live keys
            "eyJ[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+" # JWT tokens
            "(?:password|secret|key|token)\s*[=:]\s*[\"'][^\"']{10,}[\"']" # Explicit secret assignments
            "ghp_[a-zA-Z0-9_]{36}"              # GitHub tokens
            "xoxb-[a-zA-Z0-9_-]+"               # Slack bot tokens
          )

          SECRETS_FOUND=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if find dist/ -type f \( -name "*.js" -o -name "*.html" -o -name "*.css" \) \
              -exec grep -l -E "$pattern" {} \; 2>/dev/null | head -1; then
              echo "âŒ Potential secret found with pattern: $pattern"
              SECRETS_FOUND=true
            fi
          done

          if [ "$SECRETS_FOUND" = "true" ]; then
            echo "âŒ Secrets detected in build output"
            exit 1
          fi

          # VÃ©rifier la taille du bundle
          TOTAL_SIZE=$(du -sb dist/ | cut -f1)
          if [ $TOTAL_SIZE -gt 52428800 ]; then # 50MB
            echo "âš ï¸ Bundle size is large: $(du -sh dist/)"
          fi

          echo "âœ… Build security check passed"

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  deploy:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifact
        uses: actions/download-artifact@v5
        with:
          name: production-build
          path: dist/

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v41.1.4
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: ðŸ” Post-deployment health check
        run: |
          # Attendre que le dÃ©ploiement soit accessible
          sleep 30

          # VÃ©rifier que le site rÃ©pond
          URL="${{ steps.deploy.outputs.url }}"
          if curl -f -s "$URL" > /dev/null; then
            echo "âœ… Deployment accessible at $URL"
          else
            echo "âŒ Deployment health check failed"
            exit 1
          fi

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          ENV_NAME="${{ github.event.inputs.environment || 'production' }}"
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"
          echo "- **Environment**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy time**: $(date)" >> $GITHUB_STEP_SUMMARY

          # Set deployment URL for environment (post-deployment)
          echo "DEPLOYMENT_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT
